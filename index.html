<!DOCTYPE html>
<html lang="hi">
<head>
    <title>Saurabh Village Tracker - Final</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif; }
        #map { height: 100vh; width: 100%; }
        
        .controls { position: absolute; top: 10px; left: 50px; z-index: 1000; display: flex; flex-direction: column; gap: 8px; }
        .search-box { background: white; padding: 10px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); border: 1px solid #ccc; width: 220px; }
        
        .report-btn { background: #000; color: white; border: none; padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer; }

        .village-label { background: none !important; border: none !important; color: black !important; font-weight: bold !important; font-size: 11px !important; text-shadow: 1px 1px 2px white; }

        /* Popup Buttons */
        .visit-btn { display: block; margin-top: 5px; padding: 8px; color: white !important; text-align: center; border-radius: 5px; font-weight: bold; cursor: pointer; border: none; width: 100%; font-size: 12px; }
        .btn-red { background: #ea4335; }
        .btn-yellow { background: #fbbc05; color: black !important; }
        .btn-green { background: #34a853; }
        .btn-reset { background: #5f6368; margin-top: 5px; } /* Reset Button */
        
        .nav-link { display: block; margin-top: 8px; text-align: center; background: #4285F4; color: white !important; font-weight: bold; text-decoration: none; padding: 8px; border-radius: 5px; font-size: 12px; }
        
        .note-area { width: 100%; margin-top: 8px; border: 1px solid #ddd; border-radius: 4px; padding: 5px; font-size: 12px; height: 50px; box-sizing: border-box; }
        .save-note-btn { background: #1a73e8; color: white; border: none; padding: 6px; width: 100%; border-radius: 4px; margin-top: 5px; cursor: pointer; font-size: 11px; }
        
        .user-dot { background: #007bff; width: 14px; height: 14px; border-radius: 50%; border: 2px solid white; }
    </style>
</head>
<body>

<div class="controls">
    <input type="text" id="villageSearch" class="search-box" placeholder="Gaon khojein..." onkeyup="searchVillage()">
    <button class="report-btn" onclick="downloadReport()">üì• Download Report</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
    var satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');

    var map = L.map('map', { center: [26.34, 83.75], zoom: 11, layers: [osm] });
    L.control.layers({ "Road": osm, "Satellite": satellite }).addTo(map);

    var villages = [
        {n: "MOHRA", c: [26.3414606, 83.630171]}, {n: "GANDER", c: [26.4003528, 83.7946722]},
        {n: "PIPARA KHEMKARAN", c: [26.3668061, 83.809102]}, {n: "BIRPURMISIR", c: [26.3605785, 83.8257077]},
        {n: "SERWAONBHANAULI", c: [26.3685501, 83.8305524]}, {n: "AMRITKUNDA", c: [26.3542772, 83.8142119]},
        {n: "POKHAR BHINDA", c: [26.3450419, 83.8005519]}, {n: "BANJARIA", c: [26.3425068, 83.7875302]},
        {n: "TILOULI", c: [26.3111121, 83.792178]}, {n: "MARKARA", c: [26.3221854, 83.7983656]},
        {n: "AJAIPURA", c: [26.3785429, 83.6997074]}, {n: "NAIPUR", c: [26.3575165, 83.7010037]},
        {n: "HARNAHI", c: [26.3582377, 83.6849608]}, {n: "HANAUTA", c: [26.3619095, 83.6732463]},
        {n: "DUMARI", c: [26.3697109, 83.754739]}, {n: "BHALUANI", c: [26.3671337, 83.7689413]},
        {n: "HARDEORA", c: [26.3436546, 83.7169443]}, {n: "TALAURA", c: [26.3486909, 83.6966474]},
        {n: "BIJAPUR GHHANGTOUR", c: [26.3497392, 83.8431547]}, {n: "JIGANI SONHOULI", c: [26.3287496, 83.8150883]},
        {n: "SONARI", c: [26.3367081, 83.766701]}, {n: "BANGAROULI", c: [26.3306858, 83.7845331]},
        {n: "HARNADIH URF MAHAI KHAS", c: [26.3014012, 83.7469348]}, {n: "KHIRIA", c: [26.3225045, 83.7380975]},
        {n: "KARUANA", c: [26.3205442, 83.7565875]}, {n: "MISRA KHUDIA", c: [26.3263522, 83.7543065]},
        {n: "BADIPUR", c: [26.3549913, 83.7516825]}, {n: "BARAULI", c: [26.3450663, 83.7244576]},
        {n: "PARSIA CHAUBEY", c: [26.3111954, 83.7148098]}, {n: "BARAON", c: [26.3479327, 83.6479107]},
        {n: "BHIKHAMPURA", c: [26.3234769, 83.6978126]}, {n: "BADYA HARDO", c: [26.3216966, 83.6912572]}
    ];

    var trackerStore = JSON.parse(localStorage.getItem('saurabhTracker') || '{}');
    var markers = [];

    function renderMarkers() {
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        villages.forEach(function(v) {
            var data = trackerStore[v.n] || { count: 0, note: "", dates: [] };
            var color = data.count >= 2 ? "#34a853" : (data.count === 1 ? "#fbbc05" : "red");
            var icon = L.divIcon({
                html: `<div style="background:${color}; width:12px; height:12px; border-radius:50%; border:2px solid #00008B;"></div>`,
                className: '', iconSize: [12, 12]
            });
            var marker = L.marker(v.c, {icon: icon}).addTo(map);
            marker.bindTooltip(v.n, { permanent: true, direction: 'top', className: 'village-label', offset: [0, -8] });
            
            marker.on('click', function() {
                var btnClass = data.count === 0 ? "btn-red" : (data.count === 1 ? "btn-yellow" : "btn-green");
                var btnText = data.count === 0 ? "Mark 1st Visit" : (data.count === 1 ? "Mark 2nd Visit" : "2 Visits Done ‚úÖ");
                
                var popupHtml = `<div style="min-width:180px"><b>${v.n}</b><br>
                    <button class="visit-btn ${btnClass}" onclick="updateVisit('${v.n}')">${btnText}</button>
                    <button class="visit-btn btn-reset" onclick="resetVisit('${v.n}')">üîÑ Reset Visit</button>
                    <a href="https://www.google.com/maps/dir/?api=1&destination=${v.c[0]},${v.c[1]}" target="_blank" class="nav-link">üìç Rasta Dekhein (Maps)</a>
                    <textarea id="nt-${v.n}" class="note-area" placeholder="Notes...">${data.note || ''}</textarea>
                    <button class="save-note-btn" onclick="saveNote('${v.n}')">üíæ Save Note</button></div>`;
                marker.bindPopup(popupHtml).openPopup();
            });
            markers.push(marker);
        });
    }

    window.updateVisit = function(n) {
        if (!trackerStore[n]) trackerStore[n] = { count: 0, note: "", dates: [] };
        if (trackerStore[n].count < 2) {
            trackerStore[n].count++;
            trackerStore[n].dates.push(new Date().toLocaleString('hi-IN'));
            localStorage.setItem('saurabhTracker', JSON.stringify(trackerStore));
            renderMarkers(); map.closePopup();
        }
    };

    window.resetVisit = function(n) {
        if (confirm(n + " ka data reset karein?")) {
            trackerStore[n] = { count: 0, note: "", dates: [] };
            localStorage.setItem('saurabhTracker', JSON.stringify(trackerStore));
            renderMarkers(); map.closePopup();
        }
    };

    window.saveNote = function(n) {
        if (!trackerStore[n]) trackerStore[n] = { count: 0, note: "", dates: [] };
        trackerStore[n].note = document.getElementById('nt-' + n).value;
        localStorage.setItem('saurabhTracker', JSON.stringify(trackerStore));
        alert("Note saved!");
    };

    window.downloadReport = function() {
        let csv = "Village Name,Visits,Dates,Notes\n";
        villages.forEach(v => {
            let d = trackerStore[v.n] || {count:0, dates:[], note:""};
            csv += `${v.n},${d.count},"${d.dates.join(' | ')}","${d.note}"\n`;
        });
        let blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        let link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "Field_Report.csv";
        link.click();
    };

    window.searchVillage = function() {
        var term = document.getElementById('villageSearch').value.toUpperCase();
        villages.forEach(v => { if(v.n.includes(term) && term!=="") map.setView(v.c, 15); });
    };

    map.locate({watch: true, enableHighAccuracy: true});
    map.on('locationfound', e => {
        if (window.uM) map.removeLayer(window.uM);
        window.uM = L.marker(e.latlng, { icon: L.divIcon({className: 'user-dot'}) }).addTo(map);
    });
    renderMarkers();
</script>
</body>
</html>
